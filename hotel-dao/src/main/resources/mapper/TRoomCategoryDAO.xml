<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.hotel.dao.TRoomCategoryDAO">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.gt.hotel.entity.TRoomCategory">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="room_count" property="roomCount"/>
        <result column="hotel_id" property="hotelId"/>
        <result column="desc" property="desc"/>
        <result column="rack_rate" property="rackRate"/>
        <result column="deposit" property="deposit"/>
        <result column="weekend_fare_enable" property="weekendFareEnable"/>
        <result column="weekend_fare" property="weekendFare"/>
        <result column="mark_modified" property="markModified"/>
        <result column="breakfast_enable" property="breakfastEnable"/>
        <result column="breakfast_quantity" property="breakfastQuantity"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <resultMap id="MobileRoomCategoryVo" type="com.gt.hotel.vo.MobileRoomCategoryVo">
        <collection property="infrastructureRelations" select="com.gt.hotel.dao.TInfrastructureRelationDAO.findRelationVoListByRefIdAndModule"
                    column="{module=module,refId=id}"/>
        <collection property="images" select="com.gt.hotel.dao.TFileRecordDAO.findRecordVoListByRefIdAndModule" column="{module=module,refId=id}"/>
    </resultMap>

    <resultMap id="ErpRoomCategoryVo" type="com.gt.hotel.vo.erp.ErpRoomCategoryVo">
        <!-- 客房列表 -->
        <collection property="roomList" select="com.gt.hotel.dao.TRoomDAO.queryRoomListAll" column="{hotelId=hotelId,categoryId=id}"/>
        <!-- 预约客房数量 -->
        <!--<result property="bookingCount" select="com.gt.hotel.dao.TOrderDAO.erpFindTodayBookingByCategoryId" column="{hotelId=hotelId,categoryId=id}"/>-->

    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, name, room_count, hotel_id, desc, rack_rate, deposit, weekend_fare_enable, weekend_fare, mark_modified, breakfast_enable, breakfast_quantity, created_by, created_at, updated_by, updated_at
    </sql>


    <select id="queryRoomCategory" resultType="com.gt.hotel.vo.RoomCategoryVo">
        SELECT hotel_id hotelId, id categoryId, name, room_count roomCount, rack_rate rackRate, deposit, weekend_fare_enable weekendFareEnable,
        weekend_fare weekendFare
        FROM t_room_category
        WHERE mark_modified = 0
        <if test="queryRoomCategory.categoryId != null">
            AND id = #{queryRoomCategory.categoryId}
        </if>
        <if test="queryRoomCategory.hotelId != null">
            AND hotel_id = #{queryRoomCategory.hotelId}
        </if>
    </select>

    <select id="queryMobileRoomCategory" resultMap="MobileRoomCategoryVo">
        SELECT
        category.id,
        category.hotel_id hotelId,
        category.`name`,
        category.rack_rate rackRate,
        category.`desc`,
        category.deposit,
        category.weekend_fare_enable weekendFareEnable,
        category.weekend_fare weekendFare,
        category.breakfast_enable breakfastEnable,
        category.breakfast_quantity breakfastQuantity,
        category.room_count roomCount,
        setting.remnant_room_enable remnantRoomEnable,
        ifnull(calendar.price, 0) calenderPrice,
        IFNULL(SUM(o.room_order_num), 0) orderCount,
        # 房型 常量固定值 see CommonConstan
        'ROOM_CATEGORY' AS module,
        (CASE category.weekend_fare_enable
        WHEN 0
        THEN IFNULL(calendar.price, IF(DAYOFWEEK(#{param.roomInTime}) IN (6, 7), category.weekend_fare, category.rack_rate))
        WHEN 1
        THEN (IFNULL(calendar.price, category.rack_rate)) END) displayPrice
        FROM t_room_category category
        JOIN t_hotel_setting setting ON category.hotel_id = setting.hotel_id
        LEFT JOIN (SELECT
        category_id,
        price
        FROM t_room_calendar
        WHERE
        <![CDATA[
          #{param.roomInTime} >= begin_time AND #{param.roomInTime} <= end_time
        ]]>
        ) calendar ON category.id = calendar.category_id
        LEFT JOIN (SELECT
        tor.category_id,
        o.room_order_num,
        o.order_num
        FROM t_order o LEFT JOIN t_order_room tor ON o.order_num = tor.order_num
        WHERE
        # 所有的 到店支付 或 已支付 均确认过后的订单 则会扣减库存
        o.hotel_id = #{hotelId} AND tor.room_in_time BETWEEN #{param.roomInTime} AND #{param.roomOutTime}
        AND ((o.pay_type = 2) OR (o.pay_status = 1) ) AND o.order_status IN (1, 4) AND o.mark_modified=0 GROUP BY o.order_num ) o ON category.id = o.category_id
        WHERE category.hotel_id = #{hotelId}
        <if test="param.categoryId != null">
            AND category.id = #{param.categoryId}
        </if>
        AND category.mark_modified = 0
        GROUP BY category.id
        <![CDATA[
        HAVING orderCount < room_count
        ]]>
    </select>


    <select id="findErpGroupRoomList" resultMap="ErpRoomCategoryVo">
        SELECT
            category.id,
            category.name,
            category.room_count AS                                                                                                                    roomCount,
            category.`desc`,
            category.rack_rate  AS                                                                                                                    rackRate,
            category.deposit,
            category.hotel_id   AS                                                                                                                    hotelId,
            (SELECT ifnull(sum(o.room_order_num), 0)
             FROM t_order o LEFT JOIN t_order_room tor ON o.order_num = tor.order_num
             WHERE
                 # 所有的 到店支付 或 已支付 均确认过后的订单 则会扣减库存
                 tor.room_in_time BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 1 DAY)
                 AND ((o.pay_type = 2) OR (o.pay_status = 1)) AND o.order_status IN (1, 4) AND o.mark_modified = 0 AND tor.category_id = category.id) bookingCount
        FROM t_room_category category
        WHERE category.hotel_id = #{hotelId} AND category.mark_modified = 0
    </select>


</mapper>
